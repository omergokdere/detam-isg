<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>KazandÄ±nÄ±z!</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding-top: 30px; background-color: #F7F7F7; }
    .logo { width: 150px; margin-bottom: 20px; }
    canvas { border: 5px solid #333; border-radius: 50%; margin-top: 20px; }
    #spin, #confirmButton {
      padding: 10px 20px; font-size: 20px; margin-top: 20px;
      border-radius: 6px; border: none; cursor: pointer;
    }
    #spin { background: #007BFF; color: white; }
    #spin:hover { background: #0056b3; }
    #confirmButton {
      background: #28a745; color: white; display: none;
    }
    #confirmButton:hover { background: #218838; }
    #result { font-size: 24px; font-weight: bold; margin-top: 30px; color: green; }
    .qr-code { margin-top: 20px; }
    .qr-code img { width: 150px; height: 150px; }
  </style>
</head>
<body>
  <!-- Block back navigation on this page -->
  <script>
    // Block back navigation
    window.history.pushState(null, '', window.location.href);
    window.onpopstate = function () {
      window.history.pushState(null, '', window.location.href);
      window.location.href = 'index.html';
    };

    // Redirect to index if session data is missing
    const nav = performance.getEntriesByType("navigation")[0];
    if (nav && nav.type === "reload") {
      window.location.href = 'index.html';
    }
    if (!sessionStorage.getItem('ad') ||
        !sessionStorage.getItem('email') ||
        !sessionStorage.getItem('telefon')) {
      window.location.href = 'index.html';
    }

    // Language preference
    const lang = sessionStorage.getItem('lang') || 'tr';
    const translations = {
      tr: {
        title: "KazandÄ±nÄ±z!",
        congrats: "Tebrikler! ðŸŽ‰",
        description: "5 sorudan 5'ini doÄŸru yanÄ±tladÄ±nÄ±z. Åžimdi Ã§arkÄ± Ã§evirerek Ã¶dÃ¼lÃ¼nÃ¼zÃ¼ kazanÄ±n!",
        spin: "Ã‡evir!",
        confirm: "Hediyemi Al",
        prizes: ["Karabina", "GÃ¶z Ã–lÃ§Ã¼m Testi", "Duyma Testi", "Kulak TÄ±kacÄ±"],
        resultPrefix: "KazandÄ±ÄŸÄ±nÄ±z: ",
      },
      en: {
        title: "You Won!",
        congrats: "Congratulations! ðŸŽ‰",
        description: "You answered all 5 questions correctly. Spin the wheel to claim your prize!",
        spin: "Spin!",
        confirm: "Claim My Prize",
        prizes: ["Carabiner", "Eye Measure. Test", "Hearing Test", "Earplugs"],
        resultPrefix: "Your Prize: ",
      }
    };

    const t = translations[lang];
    document.title = t.title;
  </script>

  <img class="logo" src="detam.jpg" alt="Detam Logo" />
  <h1 id="congrats"></h1>
  <p id="description"></p>
  <div style="position: relative; display: inline-block;">
    <canvas id="wheel" width="400" height="400"></canvas>
    <div id="pointer" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-size: 48px; color: red;">
      ðŸ¢ƒ
    </div>
  </div>
  <br>
  <button id="spin"></button>
  <div id="result"></div>
  <br>
  <button id="confirmButton"></button>
  <br>
  <div class="qr-code">
    <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.detam.com.tr/&size=150x150" alt="QR Code" />
  </div>
  <script>
    // Update text based on language
    document.getElementById("congrats").textContent = t.congrats;
    document.getElementById("description").textContent = t.description;
    document.getElementById("spin").textContent = t.spin;
    document.getElementById("confirmButton").textContent = t.confirm;

    // Wheel drawing and spinning
    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;
    const centerX = w / 2, centerY = h / 2, radius = 180;
    const segments = 4, degPer = 360 / segments;
    const colors = ["#f44336", "#4CAF50", "#2196F3", "#FFEB3B"];
    const prizes = t.prizes;
    let angle = 0, isSpun = false;

    function drawWheel() {
      for (let i = 0; i < segments; i++) {
        const start = (degPer * i) * Math.PI / 180;
        const end = (degPer * (i + 1)) * Math.PI / 180;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, start, end);
        ctx.fillStyle = colors[i];
        ctx.fill();
        ctx.stroke();
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(start + (end - start) / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#fff";
        ctx.font = "18px Arial";
        ctx.fillText(prizes[i], radius - 10, 10);
        ctx.restore();
      }
    }
    drawWheel();

    let kazanan; // global scope

    document.getElementById("spin").addEventListener("click", () => {
      if (isSpun) return;
      isSpun = true;
      document.getElementById("result").textContent = "";
      let rotation = Math.floor(Math.random() * 360) + 1080;
      let current = 0;
      const interval = setInterval(() => {
        angle = (angle + 10) % 360;
        ctx.clearRect(0, 0, w, h);
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(angle * Math.PI / 180);
        ctx.translate(-centerX, -centerY);
        drawWheel();
        ctx.restore();
        current += 10;
        if (current >= rotation) {
          clearInterval(interval);
          const final = angle % 360;
          const adj = (360 - final + 270) % 360;
          const idx = Math.floor(adj / degPer);
          kazanan = prizes[idx];
          document.getElementById("result").textContent = t.resultPrefix + kazanan;
          document.getElementById("confirmButton").style.display = "inline-block";
        }
      }, 20);
    });

    // "Claim My Prize" button functionality
    document.getElementById("confirmButton").addEventListener("click", async function () {
      const btn = this;
      btn.disabled = true;
      const ad = sessionStorage.getItem('ad');
      const email = sessionStorage.getItem('email');
      const tel = sessionStorage.getItem('telefon');
      const odul = kazanan;

      try {
        const res = await fetch('https://script.google.com/macros/s/AKfycbxEkcC6abIGwyjwqguW1po214L6_CqzCF5P4_HXAkkeIm6c77t5p36QPDALxiRpM7tmjA/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ adSoyad: ad, email: email, telefon: tel, odul: odul })
        });
        const msg = (await res.text()).trim();
        if (msg === 'OK') {
          alert(lang === 'en' ? 'Your prize has been recorded. Redirecting to detam.com.tr.' : 'Ã–dÃ¼lÃ¼nÃ¼zÃ¼ kaydettik. detam.com.trâ€™ye yÃ¶nlendiriliyorsunuz.');
          sessionStorage.clear();
          setTimeout(() => window.location.replace('https://detam.com.tr'), 5000);
        } else {
          alert('Hata: ' + msg);
          btn.disabled = false;
        }
      } catch (error) {
        alert('Bir hata oluÅŸtu: ' + error);
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>